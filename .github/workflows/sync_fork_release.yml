name: Auto Sync Fork with Releases

on:
  workflow_dispatch:

# ğŸ” æ­£ç¡®çš„æƒé™é…ç½®
permissions:
  contents: write   # å…è®¸æ¨é€ä»£ç å’Œæ ‡ç­¾
  actions: write    # å…³é”®ï¼šå…è®¸ç®¡ç† Actions å’Œå·¥ä½œæµæ–‡ä»¶

env:
  UPSTREAM_REPO: "orion-lib/OrionTV"
  UPSTREAM_URL: "https://github.com/orion-lib/OrionTV.git"

jobs:
  sync-fork:
    runs-on: ubuntu-latest
    # ç§»é™¤äº†jobçº§åˆ«çš„permissionsé…ç½®ï¼Œä½¿ç”¨ä¸Šæ–¹çš„å…¨å±€é…ç½®

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # ä½¿ç”¨ PAT ä»¥è·å–è¶³å¤Ÿæƒé™
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Clean Local Tags and Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== å¼€å§‹æ¸…ç†æœ¬åœ° Tags å’Œ Releases ==="
          
          # è·å–æœ¬åœ°æ‰€æœ‰tags
          LOCAL_TAGS=$(git tag -l)
          echo "å‘ç°æœ¬åœ° Tags:"
          echo "$LOCAL_TAGS"
          echo ""
          
          # åˆ é™¤æœ¬åœ°æ‰€æœ‰releases
          echo "ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°Releases..."
          LOCAL_RELEASES_URL="https://api.github.com/repos/$GITHUB_REPOSITORY/releases"
          PAGE=1
          
          while true; do
            RELEASES_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "$LOCAL_RELEASES_URL?page=$PAGE&per_page=100")
            RELEASES_COUNT=$(echo "$RELEASES_RESPONSE" | jq -r 'length')
            
            if [ "$RELEASES_COUNT" -eq 0 ]; then
              break
            fi
            
            # åˆ é™¤å½“å‰é¡µçš„æ‰€æœ‰releases
            echo "$RELEASES_RESPONSE" | jq -r '.[] | "\(.id) \(.tag_name)"' | while read RELEASE_ID TAG_NAME; do
              if [ -n "$RELEASE_ID" ]; then
                echo "åˆ é™¤Release: $TAG_NAME (ID: $RELEASE_ID)"
                curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                  "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/$RELEASE_ID" || echo "åˆ é™¤å¤±è´¥æˆ–å·²ä¸å­˜åœ¨"
              fi
            done
            ((PAGE++))
          done
          
          # åˆ é™¤è¿œç¨‹tags
          echo "ğŸ—‘ï¸ åˆ é™¤è¿œç¨‹Tags..."
          for TAG in $LOCAL_TAGS; do
            echo "åˆ é™¤è¿œç¨‹Tag: $TAG"
            git push origin --delete "refs/tags/$TAG" 2>/dev/null || true
          done
          
          # åˆ é™¤æœ¬åœ°tags
          echo "ğŸ—‘ï¸ åˆ é™¤æœ¬åœ°Tags..."
          git tag -l | xargs git tag -d 2>/dev/null || true
          
          echo "âœ… æœ¬åœ°æ¸…ç†å®Œæˆ"
          echo ""

      - name: Add Upstream and Fetch Tags
        run: |
          git remote add upstream ${{ env.UPSTREAM_URL }} || true
          # å¼ºåˆ¶è·å–ä¸Šæ¸¸æ‰€æœ‰tags
          git fetch upstream --tags -f

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Sync Upstream Tags and Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== å¼€å§‹åŒæ­¥ä¸Šæ¸¸ ${{ env.UPSTREAM_REPO }} çš„ Tags å’Œ Releases ==="
          
          # æ¨é€æ‰€æœ‰ä¸Šæ¸¸tagsåˆ°æœ¬åœ°ä»“åº“
          echo "ğŸ“¤ æ¨é€æ‰€æœ‰Tagsåˆ°æœ¬åœ°ä»“åº“..."
          git push origin --tags -f
          
          # é€šè¿‡GitHub APIè·å–æ‰€æœ‰ä¸Šæ¸¸Releases
          UPSTREAM_RELEASES_URL="https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases"
          PAGE=1
          ALL_TAGS=""
          
          while true; do
            RELEASES_PAGE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "$UPSTREAM_RELEASES_URL?page=$PAGE&per_page=100")
            
            if [ "$(echo "$RELEASES_PAGE" | jq -r 'length')" -eq 0 ]; then
              break
            fi
            
            PAGE_TAGS=$(echo "$RELEASES_PAGE" | jq -r '.[] | select(.draft == false) | .tag_name')
            ALL_TAGS="$ALL_TAGS"$'\n'"$PAGE_TAGS"
            ((PAGE++))
          done
          
          # æ¸…ç†å¹¶æ’åºæ ‡ç­¾
          ALL_TAGS=$(echo "$ALL_TAGS" | grep -v '^$' | sort -V -r)
          
          echo "å‘ç°ä¸Šæ¸¸ Releases æ ‡ç­¾:"
          echo "$ALL_TAGS"
          echo ""

          # å¤„ç†æ¯ä¸ªæœ‰Releaseçš„Tag
          for TAG in $ALL_TAGS; do
            echo "ğŸ” å¤„ç† Tag: $TAG"
            
            # è·å–ä¸Šæ¸¸Releaseè¯¦ç»†ä¿¡æ¯
            UPSTREAM_RELEASE_URL="https://api.github.com/repos/${{ env.UPSTREAM_REPO }}/releases/tags/$TAG"
            UPSTREAM_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$UPSTREAM_RELEASE_URL")
            UPSTREAM_RELEASE_ID=$(echo "$UPSTREAM_RESPONSE" | jq -r '.id // empty')
            
            if [ -z "$UPSTREAM_RELEASE_ID" ]; then
              echo "âŒ æ— æ³•è·å–ä¸Šæ¸¸Releaseä¿¡æ¯: $TAG"
              echo ""
              continue
            fi
            
            # æ£€æŸ¥Assetsæ•°é‡
            ASSETS_COUNT=$(echo "$UPSTREAM_RESPONSE" | jq -r '.assets | length')
            if [ "$ASSETS_COUNT" -eq 0 ]; then
              echo "â„¹ï¸ ä¸Šæ¸¸Releaseæ²¡æœ‰Assets: $TAG"
              echo ""
              continue
            fi
            
            echo "âœ… å‘ç° $ASSETS_COUNT ä¸ªAssets"
            
            # ä¸‹è½½Assetsåˆ°ä¸´æ—¶ç›®å½•
            echo "ğŸ“¥ ä¸‹è½½Assets..."
            mkdir -p "temp_assets/$TAG"
            ASSET_URLS=$(echo "$UPSTREAM_RESPONSE" | jq -r '.assets[].browser_download_url')
            DOWNLOAD_SUCCESS=false
            
            for ASSET_URL in $ASSET_URLS; do
              if [ -n "$ASSET_URL" ]; then
                FILENAME="temp_assets/$TAG/$(basename "$ASSET_URL")"
                echo "â¬‡ï¸ ä¸‹è½½: $(basename "$ASSET_URL")"
                if curl -L -f -o "$FILENAME" "$ASSET_URL"; then
                  echo "âœ… ä¸‹è½½æˆåŠŸ"
                  DOWNLOAD_SUCCESS=true
                else
                  echo "âŒ ä¸‹è½½å¤±è´¥: $ASSET_URL"
                  rm -f "$FILENAME"
                fi
              fi
            done
            
            # åˆ›å»ºReleaseï¼ˆåªæœ‰æˆåŠŸä¸‹è½½äº†æ–‡ä»¶æ‰åˆ›å»ºï¼‰
            if [ "$DOWNLOAD_SUCCESS" = true ] && [ "$(ls -A temp_assets/$TAG/ 2>/dev/null)" ]; then
              echo "ğŸš€ åˆ›å»ºRelease: $TAG"
              
              # è·å–ä¸Šæ¸¸Releaseçš„è¯¦ç»†ä¿¡æ¯ç”¨äºåˆ›å»ºæœ¬åœ°Release
              UPSTREAM_NAME=$(echo "$UPSTREAM_RESPONSE" | jq -r '.name // empty')
              UPSTREAM_BODY=$(echo "$UPSTREAM_RESPONSE" | jq -r '.body // empty')
              UPSTREAM_PRERELEASE=$(echo "$UPSTREAM_RESPONSE" | jq -r '.prerelease // false')
              
              # è®¾ç½®Releaseåç§°å’Œæè¿°
              RELEASE_NAME="${UPSTREAM_NAME:-$TAG}"
              RELEASE_BODY="${UPSTREAM_BODY:-Automatically synced from ${{ env.UPSTREAM_REPO }} on $(date +'%Y-%m-%d %H:%M:%S')}"
              
              RELEASE_DATA='{
                "tag_name": "'$TAG'",
                "name": "'$RELEASE_NAME'",
                "body": "'$(echo "$RELEASE_BODY" | sed 's/"/\\"/g' | tr -d '\n')'",
                "draft": false,
                "prerelease": '$UPSTREAM_PRERELEASE'
              }'
              
              CREATE_RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
                -d "$RELEASE_DATA")
              
              NEW_RELEASE_ID=$(echo "$CREATE_RESPONSE" | jq -r '.id // empty')
              
              if [ -n "$NEW_RELEASE_ID" ]; then
                echo "âœ… Releaseåˆ›å»ºæˆåŠŸï¼ŒID: $NEW_RELEASE_ID"
                
                # ä¸Šä¼ æ‰€æœ‰Assets
                UPLOAD_SUCCESS=0
                UPLOAD_TOTAL=0
                
                for ASSET_FILE in temp_assets/$TAG/*; do
                  if [ -f "$ASSET_FILE" ]; then
                    ((UPLOAD_TOTAL++))
                    ASSET_NAME=$(basename "$ASSET_FILE")
                    echo "â¬†ï¸ ä¸Šä¼  ($UPLOAD_TOTAL/$ASSETS_COUNT): $ASSET_NAME"
                    
                    UPLOAD_RESPONSE=$(curl -s -X POST \
                      -H "Authorization: token $GITHUB_TOKEN" \
                      -H "Accept: application/vnd.github.v3+json" \
                      -H "Content-Type: application/octet-stream" \
                      "https://uploads.github.com/repos/$GITHUB_REPOSITORY/releases/$NEW_RELEASE_ID/assets?name=$ASSET_NAME" \
                      --data-binary @"$ASSET_FILE")
                    
                    if echo "$UPLOAD_RESPONSE" | jq -e '.id' >/dev/null 2>&1; then
                      echo "âœ… ä¸Šä¼ æˆåŠŸ: $ASSET_NAME"
                      ((UPLOAD_SUCCESS++))
                    else
                      echo "âŒ ä¸Šä¼ å¤±è´¥: $ASSET_NAME"
                      echo "å“åº”: $UPLOAD_RESPONSE"
                    fi
                  fi
                done
                
                echo "ğŸ“Š ä¸Šä¼ ç»Ÿè®¡: $UPLOAD_SUCCESS/$UPLOAD_TOTAL ä¸ªAssetsä¸Šä¼ æˆåŠŸ"
              else
                echo "âŒ Releaseåˆ›å»ºå¤±è´¥"
                echo "å“åº”: $CREATE_RESPONSE"
              fi
            else
              echo "âŒ æ²¡æœ‰å¯ç”¨çš„Assetsæ–‡ä»¶ï¼Œè·³è¿‡åˆ›å»ºRelease"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf "temp_assets/$TAG"
            echo ""
          done

      - name: Final Cleanup
        run: |
          rm -rf temp_assets
          echo "=== åŒæ­¥å®Œæˆ ==="
          echo "âœ… Tags å’Œ Releases å·²å®Œå…¨é‡æ–°åŒæ­¥"
          echo "ğŸ“Š æŸ¥çœ‹ç»“æœ: https://github.com/$GITHUB_REPOSITORY/releases"
